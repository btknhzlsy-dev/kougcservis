<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servis Takip Sistemi</title>
    
    <!-- Tasarım Kütüphanesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Kütüphaneleri -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Kütüphaneleri -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @media print {
            @page { size: landscape; margin: 3mm; }
            body { background: white; margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
            .print-hidden { display: none !important; }
            .grid-print { display: grid !important; grid-template-columns: repeat(2, 1fr) !important; width: 100% !important; gap: 2mm !important; }
            textarea, input { border: none !important; resize: none !important; overflow: hidden !important; background: transparent !important; }
            .h-print { height: 34mm !important; } /* 34mm x 6 satır = ~204mm (A4 Yüksekliğine sığar) */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            /* Tablo çizgilerini netleştir */
            .border-print { border-width: 1px !important; border-color: #000 !important; }
        }
        /* Kaydırma çubuklarını gizle */
        textarea::-webkit-scrollbar { display: none; }
        textarea { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // BURASI ÇOK ÖNEMLİ: FIREBASE AYARLARI
        // Firebase konsolundan aldığınız "firebaseConfig" kodunu buradaki süslü parantezlerin içine yapıştırın.
        // ==========================================
        let firebaseConfig;
        let collectionId = 'genel_cerrahi_hastalar'; 

        // 1. ÖNİZLEME ORTAMI İÇİN OTOMATİK AYAR
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') {
                collectionId = `artifacts/${__app_id}/public/data/patients`; 
            }
        } 
        // 2. YEREL KULLANIM İÇİN AYAR
        else {
            firebaseConfig = {
                apiKey: "AIzaSyBNOF689rvb5eGoFTdwJyzzIW1MlyB1RFg",
                authDomain: "kougcservis.firebaseapp.com",
                projectId: "kougcservis",
                storageBucket: "kougcservis.firebasestorage.app",
                messagingSenderId: "713473107939",
                appId: "1:713473107939:web:28880bfb05a055082322d6",
            };
        }
        // ==========================================

        if (!firebase.apps.length) {
             if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "BURAYA_API_KEY_GELECEK") {
                firebase.initializeApp(firebaseConfig);
            } else if (typeof __firebase_config !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
            } else {
                console.warn("Firebase ayarları eksik.");
            }
        }
        
        let auth = null;
        let db = null;
        if (firebase.apps.length) {
            auth = firebase.auth();
            db = firebase.firestore();
        }

        const { useState, useMemo, useEffect } = React;

        // --- İKONLAR ---
        const Icons = {
            Stethoscope: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></svg>,
            Printer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            UserPlus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>,
            Edit3: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            CheckCircle2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            Eye: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ImageIcon: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Maximize2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" x2="14" y1="3" y2="10"/><line x1="3" x2="10" y1="21" y2="14"/></svg>,
            PlusCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>,
            Undo2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>,
            Lock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            User: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            LogOut: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Wifi: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>,
            RefreshCw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        };

        const DOCTOR_CONFIG = {
            'SAG': { bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-200', accent: 'bg-blue-600' },
            'BK': { bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-200', accent: 'bg-emerald-600' },
            'ZC': { bg: 'bg-orange-50', text: 'text-orange-700', border: 'border-orange-200', accent: 'bg-orange-600' },
            'TS': { bg: 'bg-purple-50', text: 'text-purple-700', border: 'border-purple-200', accent: 'bg-purple-600' },
            'ES': { bg: 'bg-rose-50', text: 'text-rose-700', border: 'border-rose-200', accent: 'bg-rose-600' },
            'EŞ': { bg: 'bg-cyan-50', text: 'text-cyan-700', border: 'border-cyan-200', accent: 'bg-cyan-600' },
            'ZU': { bg: 'bg-pink-50', text: 'text-pink-700', border: 'border-pink-200', accent: 'bg-pink-600' },
            'MFA': { bg: 'bg-indigo-50', text: 'text-indigo-700', border: 'border-indigo-200', accent: 'bg-indigo-600' },
            'OB': { bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-200', accent: 'bg-amber-600' },
        };

        const generateFixedRooms = () => {
            const rooms = [];
            // 46-55 ve C yatakları
            const cRange1 = ['46','47','48','49','50','51','52','53','54'];
            for (let i = 46; i <= 55; i++) {
                rooms.push(i.toString());
                if (cRange1.includes(i.toString())) rooms.push(i + 'C');
            }
            // 24-13 ve C yatakları
            const cRange2 = ['24','23','22','21','20','19','18','17','16','15','14'];
            for (let i = 24; i >= 13; i--) {
                rooms.push(i.toString());
                if (cRange2.includes(i.toString())) rooms.push(i + 'C');
            }
            // 69-80 ve Özel C yatakları
            const cRange3 = ['74','76','78'];
            for (let i = 69; i <= 80; i++) {
                rooms.push(i.toString());
                if (cRange3.includes(i.toString())) rooms.push(i + 'C');
            }
            return rooms;
        };

        const FIXED_ROOMS = generateFixedRooms();

        const EMPTY_PATIENT_DATA = {
            odaNo: '',
            hoca: 'SAG',
            hastaAdi: '',
            taniAmeliyat: '',
            postOp: '0',
            anamnez: '',
            rejim: '',
            kanSonuc: '',
            kanSonucGorseller: [],
            vitaller: { ates: '', nabiz: '', ta: '', sat: '' },
            act: { aldigi: '', cikardigi: '', dren1: '', dren2: '', dren3: '', hemovac: '' },
            tedavi: '',
            isListesi: '',
            status: 'Stabil'
        };

        const compressImage = (base64Str, maxWidth = 800, maxHeight = 800) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            });
        };

        function LoginPage({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                if (username === 'admin' && password === '12345') {
                    onLogin();
                } else {
                    setError('Hatalı kullanıcı adı veya şifre!');
                }
            };

            return (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                    <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md border-2 border-slate-100">
                        <div className="flex flex-col items-center mb-10">
                            <div className="bg-slate-900 p-5 rounded-3xl text-white shadow-xl mb-6"><Icons.Stethoscope size={48} /></div>
                            <h1 className="text-3xl font-black text-slate-900 uppercase tracking-tighter text-center">Servis Takip</h1>
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-[0.3em] mt-2">Bulut Tabanlı Sistem</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-2 tracking-widest">Kullanıcı Adı</label>
                                <input type="text" className="w-full px-4 py-4 rounded-2xl border-2 border-slate-100 focus:border-indigo-500 outline-none font-bold text-slate-700 bg-slate-50/50 focus:bg-white" placeholder="Kullanıcı adı" value={username} onChange={(e) => setUsername(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-2 tracking-widest">Şifre</label>
                                <input type="password" className="w-full px-4 py-4 rounded-2xl border-2 border-slate-100 focus:border-indigo-500 outline-none font-bold text-slate-700 bg-slate-50/50 focus:bg-white" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} />
                            </div>
                            {error && <div className="bg-red-50 text-red-600 p-4 rounded-xl text-xs font-bold flex items-center gap-3 animate-pulse border border-red-100"><Icons.X size={18} /> {error}</div>}
                            <button type="submit" className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase tracking-[0.2em] hover:bg-slate-800 transition-all shadow-xl shadow-slate-200 active:scale-95 flex items-center justify-center gap-3 group">Giriş Yap <Icons.CheckCircle2 size={20} className="text-slate-500 group-hover:text-white transition-colors" /></button>
                        </form>
                    </div>
                </div>
            );
        }

        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [patients, setPatients] = useState({});
            const [user, setUser] = useState(null);
            const [filterHoca, setFilterHoca] = useState('Hepsi');
            const [searchTerm, setSearchTerm] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isPreviewOpen, setIsPreviewOpen] = useState(false);
            const [formData, setFormData] = useState(EMPTY_PATIENT_DATA);
            const [isNewPatientEntry, setIsNewPatientEntry] = useState(false);
            const [lightboxImage, setLightboxImage] = useState(null);
            const [lastDeleted, setLastDeleted] = useState(null);
            const [isSyncing, setIsSyncing] = useState(true);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                const initAuth = async () => {
                    if (!auth) {
                        setAuthError("Firebase başlatılamadı. Ayarları kontrol edin.");
                        return;
                    }
                    try {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (err) {
                        console.error("Auth hatası:", err);
                        setAuthError(err.message);
                    }
                };
                initAuth();
                
                if (auth) {
                    const unsubscribeAuth = auth.onAuthStateChanged((currentUser) => { setUser(currentUser); });
                    const savedAuth = localStorage.getItem('isAuthenticated');
                    if (savedAuth === 'true') {
                        setIsAuthenticated(true);
                    }
                    setTimeout(() => setIsLoading(false), 800);
                    return () => unsubscribeAuth();
                } else {
                    setIsLoading(false);
                }
            }, []);

            useEffect(() => {
                if (!user || !db) return;

                let patientsRef;
                if (collectionId.includes('/')) {
                   const pathParts = collectionId.split('/');
                   let ref = db.collection(pathParts[0]);
                   for (let i = 1; i < pathParts.length; i++) {
                       if (i % 2 === 1) ref = ref.doc(pathParts[i]);
                       else ref = ref.collection(pathParts[i]);
                   }
                   patientsRef = ref;
                } else {
                    patientsRef = db.collection(collectionId);
                }
                
                const unsubscribeSnapshot = patientsRef.onSnapshot((snapshot) => {
                    const newPatients = {};
                    snapshot.forEach(doc => { newPatients[doc.id] = doc.data(); });
                    setPatients(newPatients);
                    setIsSyncing(false);
                }, (error) => { 
                    console.error("Veri çekme hatası:", error); 
                    setIsSyncing(false);
                });
                
                return () => unsubscribeSnapshot();
            }, [user]);

            const handleLoginSuccess = () => { setIsAuthenticated(true); localStorage.setItem('isAuthenticated', 'true'); };
            const handleLogout = () => { setIsAuthenticated(false); localStorage.removeItem('isAuthenticated'); };

            const openEntryForm = (roomNo = null) => {
                if (roomNo) {
                    setFormData(patients[roomNo] || { ...EMPTY_PATIENT_DATA, odaNo: roomNo });
                    setIsNewPatientEntry(false);
                } else {
                    setFormData(EMPTY_PATIENT_DATA);
                    setIsNewPatientEntry(true);
                }
                setIsModalOpen(true);
            };

            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                const newImages = [];
                for (const file of files) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    await new Promise(resolve => {
                        reader.onloadend = async () => {
                            const compressed = await compressImage(reader.result);
                            newImages.push(compressed);
                            resolve();
                        };
                    });
                }
                setFormData(prev => ({ ...prev, kanSonucGorseller: [...(prev.kanSonucGorseller || []), ...newImages] }));
            };

            const removeImage = (index) => {
                setFormData(prev => ({ ...prev, kanSonucGorseller: prev.kanSonucGorseller.filter((_, i) => i !== index) }));
            };

            const updateField = (roomNo, field, value) => {
                if (!user) { alert("Oturum açık değil!"); return; }
                const currentData = patients[roomNo];
                if (!currentData) return;
                const newData = { ...currentData, [field]: value };
                setPatients(prev => ({ ...prev, [roomNo]: newData }));
                
                if (collectionId.includes('/')) {
                   const pathParts = collectionId.split('/');
                   let ref = db.collection(pathParts[0]);
                   for (let i = 1; i < pathParts.length; i++) {
                       if (i % 2 === 1) ref = ref.doc(pathParts[i]);
                       else ref = ref.collection(pathParts[i]);
                   }
                   ref.doc(roomNo).set(newData).catch(err => console.error(err));
                } else {
                   db.collection(collectionId).doc(roomNo).set(newData).catch(err => console.error(err));
                }
            };

            const savePatient = async () => {
                if (!formData.hastaAdi || !formData.odaNo) { alert("Lütfen Hasta Adı ve Oda No giriniz."); return; }
                if (!user) { alert("Veritabanına bağlanılamadı."); return; }

                try {
                    let ref;
                    if (collectionId.includes('/')) {
                       const pathParts = collectionId.split('/');
                       ref = db.collection(pathParts[0]);
                       for (let i = 1; i < pathParts.length; i++) {
                           if (i % 2 === 1) ref = ref.doc(pathParts[i]);
                           else ref = ref.collection(pathParts[i]);
                       }
                    } else {
                       ref = db.collection(collectionId);
                    }
                    await ref.doc(formData.odaNo).set(formData);
                    setIsModalOpen(false);
                } catch (error) { 
                    alert("Hata: " + error.message); 
                }
            };

            const deletePatient = async (roomNo) => {
                if (window.confirm(`${roomNo} nolu odadaki hastayı silmek/boşaltmak istediğinize emin misiniz?`)) {
                    const patientData = patients[roomNo];
                    setLastDeleted({ roomNo, data: patientData });
                    try {
                        let ref;
                        if (collectionId.includes('/')) {
                           const pathParts = collectionId.split('/');
                           ref = db.collection(pathParts[0]);
                           for (let i = 1; i < pathParts.length; i++) {
                               if (i % 2 === 1) ref = ref.doc(pathParts[i]);
                               else ref = ref.collection(pathParts[i]);
                           }
                        } else {
                           ref = db.collection(collectionId);
                        }
                        await ref.doc(roomNo).delete();
                    } catch (error) { console.error("Silme hatası:", error); }
                }
            };

            const undoDelete = async () => {
                if (lastDeleted) {
                    try {
                        let ref;
                        if (collectionId.includes('/')) {
                           const pathParts = collectionId.split('/');
                           ref = db.collection(pathParts[0]);
                           for (let i = 1; i < pathParts.length; i++) {
                               if (i % 2 === 1) ref = ref.doc(pathParts[i]);
                               else ref = ref.collection(pathParts[i]);
                           }
                        } else {
                           ref = db.collection(collectionId);
                        }
                        await ref.doc(lastDeleted.roomNo).set(lastDeleted.data);
                        setLastDeleted(null);
                    } catch (error) { console.error("Geri alma hatası:", error); }
                }
            };

            const allCurrentRooms = useMemo(() => {
                const extraRooms = Object.keys(patients).filter(r => !FIXED_ROOMS.includes(r));
                return [...FIXED_ROOMS, ...extraRooms];
            }, [patients]);

            const visibleRooms = useMemo(() => {
                return allCurrentRooms.filter(roomNo => {
                    const patient = patients[roomNo];
                    const matchSearch = !searchTerm || (
                        roomNo.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        (patient && patient.hastaAdi.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (patient && patient.taniAmeliyat.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                    const matchHoca = filterHoca === 'Hepsi' || (patient && patient.hoca === filterHoca);
                    return matchSearch && matchHoca;
                });
            }, [patients, searchTerm, filterHoca, allCurrentRooms]);

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-slate-100 flex items-center justify-center">
                        <div className="flex flex-col items-center gap-4">
                            <div className="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-slate-900"></div>
                            {authError && <div className="text-red-500 font-bold p-4 bg-red-100 rounded-lg max-w-md text-center text-xs">Firebase Bağlantı Hatası: {authError}<br/>Lütfen internet bağlantınızı ve Firebase ayarlarınızı kontrol edin.</div>}
                        </div>
                    </div>
                );
            }

            if (!isAuthenticated) return <LoginPage onLogin={handleLoginSuccess} />;

            // --- YAZDIRMA ÖNİZLEME (ÖZELLEŞTİRİLMİŞ) ---
            if (isPreviewOpen) {
                return (
                    <div className="min-h-screen bg-white">
                        <div className="print:hidden bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-[500] shadow-2xl">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsPreviewOpen(false)} className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-bold transition-all"><Icons.ChevronLeft size={20} /> Dashboard'a Dön</button>
                                <h2 className="text-xl font-black tracking-tighter uppercase">Yazdırma Önizleme (Düzenlenebilir)</h2>
                            </div>
                            <button onClick={() => window.print()} className="bg-blue-600 hover:bg-blue-500 px-8 py-2 rounded-lg font-black flex items-center gap-2 shadow-lg transition-all active:scale-95"><Icons.Printer size={20} /> Listeyi Yazdır</button>
                        </div>
                        <div className="p-1 bg-white mx-auto print:p-0 overflow-visible">
                            <div className="grid-print grid grid-cols-2 gap-px w-full max-w-[297mm] mx-auto">
                                {/* TABLO BAŞLIĞI - HER İKİ SÜTUN İÇİN */}
                                <div className="col-span-2 flex justify-between items-center border-b-2 border-black pb-1 mb-1">
                                    <h1 className="text-[12pt] font-black uppercase">GENEL CERRAHİ SERVİSİ</h1>
                                    <span className="text-[9pt] font-bold">{new Date().toLocaleDateString('tr-TR')}</span>
                                </div>
                                {visibleRooms.filter(r => patients[r]).map(roomNo => {
                                    const p = patients[roomNo];
                                    return (
                                        <div key={roomNo} className="border border-black flex flex-row break-inside-avoid h-print h-[34mm] overflow-hidden bg-white">
                                            {/* SOL BLOK: Kimlik ve Anamnez */}
                                            <div className="flex flex-col w-[30%] border-r border-black">
                                                {/* Kimlik Satırı */}
                                                <div className="flex border-b border-black h-[14mm]">
                                                    <div className="w-[20%] border-r border-black flex items-center justify-center font-black text-xl bg-white">{roomNo}</div>
                                                    <div className="flex-1 p-0.5">
                                                        <div className="flex justify-between items-start">
                                                            <textarea className="w-full h-[6mm] border-none resize-none p-0 text-[8px] font-black uppercase leading-tight focus:ring-0 overflow-hidden" value={p.hastaAdi} onChange={(e) => updateField(roomNo, 'hastaAdi', e.target.value)} />
                                                            <input className="w-[15%] text-right font-black text-[9px] uppercase border-none p-0" value={p.hoca} onChange={(e) => updateField(roomNo, 'hoca', e.target.value)} />
                                                        </div>
                                                        <textarea className="w-full h-[7mm] border-none resize-none p-0 text-[7px] font-bold italic leading-none focus:ring-0 overflow-hidden" value={p.taniAmeliyat} onChange={(e) => updateField(roomNo, 'taniAmeliyat', e.target.value)} />
                                                        <div className="text-[7px] font-bold text-center border-t border-black/20 pt-0.5">PO: {p.postOp}</div>
                                                    </div>
                                                </div>
                                                {/* Anamnez Satırı */}
                                                <div className="flex-1 p-0.5 bg-gray-50 relative">
                                                    <span className="absolute top-0.5 left-0.5 text-[5px] font-black uppercase text-gray-500">Anamnez:</span>
                                                    <textarea className="w-full h-full border-none resize-none p-0 pt-2 text-[6.5px] font-medium leading-tight italic bg-transparent focus:ring-0 overflow-hidden" value={p.anamnez} onChange={(e) => updateField(roomNo, 'anamnez', e.target.value)} />
                                                </div>
                                            </div>

                                            {/* SAĞ BLOK: Takip Bilgileri - DİKEY SÜTUNLAR */}
                                            <div className="flex flex-1">
                                                {/* Rejim (YENİ SÜTUN) */}
                                                <div className="w-[8%] border-r border-black p-0.5 relative">
                                                    <div className="text-[5px] font-black uppercase text-center border-b border-black/20 mb-1">Rejim</div>
                                                    <textarea className="w-full h-full border-none resize-none text-[6.5px] font-bold text-center leading-tight focus:ring-0 overflow-hidden" value={p.rejim} onChange={(e) => updateField(roomNo, 'rejim', e.target.value)} />
                                                </div>
                                                {/* Vitaller */}
                                                <div className="w-[14%] border-r border-black flex flex-col text-[6px] font-bold">
                                                    <div className="text-[5px] font-black uppercase text-center border-b border-black bg-gray-100">Vital</div>
                                                    <div className="flex-1 flex justify-between items-center px-0.5 border-b border-black/20"><span>At:</span><span>{p.vitaller.ates}</span></div>
                                                    <div className="flex-1 flex justify-between items-center px-0.5 border-b border-black/20"><span>Nb:</span><span>{p.vitaller.nabiz}</span></div>
                                                    <div className="flex-1 flex justify-between items-center px-0.5 border-b border-black/20"><span>TA:</span><span>{p.vitaller.ta}</span></div>
                                                    <div className="flex-1 flex justify-between items-center px-0.5"><span>Sat:</span><span>{p.vitaller.sat}</span></div>
                                                </div>
                                                {/* AÇT */}
                                                <div className="w-[14%] border-r border-black flex flex-col text-[6px] font-bold">
                                                    <div className="text-[5px] font-black uppercase text-center border-b border-black bg-gray-100">AÇT</div>
                                                    <div className="flex-1 flex justify-between items-center px-0.5 border-b border-black/20"><span>A:</span><span>{p.act.aldigi}</span></div>
                                                    <div className="flex-1 flex justify-between items-center px-0.5 border-b border-black/20"><span>Ç:</span><span>{p.act.cikardigi}</span></div>
                                                    <div className="flex-1 flex justify-between items-center px-0.5 border-b border-black/20"><span>Dr:</span><span>{p.act.dren1}/{p.act.dren2}</span></div>
                                                    <div className="flex-1 flex justify-between items-center px-0.5"><span>Hw:</span><span>{p.act.hemovac}</span></div>
                                                </div>
                                                {/* Tedavi */}
                                                <div className="w-[16%] border-r border-black p-0.5 relative">
                                                    <div className="text-[5px] font-black uppercase text-center border-b border-black/20 mb-0.5">Tedavi</div>
                                                    <textarea className="w-full h-full border-none resize-none text-[6px] font-medium leading-tight focus:ring-0 overflow-hidden" value={p.tedavi} onChange={(e) => updateField(roomNo, 'tedavi', e.target.value)} />
                                                </div>
                                                {/* Kan */}
                                                <div className="w-[16%] border-r border-black p-0.5 relative">
                                                    <div className="text-[5px] font-black uppercase text-center border-b border-black/20 mb-0.5">Lab</div>
                                                    <textarea className="w-full h-full border-none resize-none text-[6px] font-black italic text-indigo-800 leading-tight focus:ring-0 overflow-hidden" value={p.kanSonuc} onChange={(e) => updateField(roomNo, 'kanSonuc', e.target.value)} />
                                                </div>
                                                {/* İş Listesi */}
                                                <div className="flex-1 p-0.5 relative bg-yellow-50/20">
                                                    <div className="text-[5px] font-black uppercase text-center border-b border-black/20 mb-0.5">Plan</div>
                                                    <textarea className="w-full h-full border-none resize-none text-[7px] font-black leading-tight focus:ring-0 overflow-hidden" value={p.isListesi} onChange={(e) => updateField(roomNo, 'isListesi', e.target.value)} />
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            // ... (Kalan kısımlar aynı) ...

            return (
                <div className="min-h-screen bg-slate-100 p-3 md:p-6 font-sans text-slate-800 antialiased leading-tight">
                    {/* ... (Lightbox ve Geri Alma aynı) ... */}
                    {lightboxImage && (
                        <div className="fixed inset-0 z-[2000] bg-black/90 flex items-center justify-center p-4 cursor-pointer" onClick={() => setLightboxImage(null)}>
                            <div className="relative max-w-5xl max-h-[90vh]">
                                <img src={lightboxImage} alt="Görsel" className="rounded-lg shadow-2xl object-contain max-h-[90vh]" />
                                <button className="absolute top-4 right-4 bg-white/20 p-2 rounded-full text-white backdrop-blur-md"><Icons.X size={24}/></button>
                            </div>
                        </div>
                    )}
                    {lastDeleted && (
                        <div className="fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 animate-bounce-in z-[3000]">
                            <span><b>{lastDeleted.roomNo}</b> nolu oda temizlendi.</span>
                            <button onClick={undoDelete} className="bg-white text-slate-900 px-3 py-1.5 rounded-lg font-bold text-sm hover:bg-slate-200 transition-colors flex items-center gap-2"><div className="rotate-180"><Icons.RefreshCw size={16} /></div> Geri Al</button>
                            <button onClick={() => setLastDeleted(null)} className="text-slate-400 hover:text-white ml-2"><Icons.X size={18} /></button>
                        </div>
                    )}
                    <header className="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden">
                        {isSyncing && <div className="absolute top-0 left-0 w-full h-1 bg-indigo-500 animate-pulse"></div>}
                        <div className="flex items-center gap-3">
                            <div className="bg-slate-900 p-2 rounded-lg text-white shadow-lg"><Icons.Stethoscope size={20} /></div>
                            <div>
                                <h1 className="text-lg font-bold text-slate-900 leading-none uppercase tracking-tighter flex items-center gap-2">Genel Cerrahi Dashboard {!isSyncing && <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full flex items-center gap-1"><Icons.Wifi size={10}/> Online</span>}</h1>
                                <p className="text-[9px] text-slate-500 font-bold uppercase tracking-widest mt-1 italic">Klinik İzlem ve Tam Yatak Planı</p>
                            </div>
                        </div>
                        <div className="flex gap-2 w-full sm:w-auto">
                            <button onClick={() => setIsPreviewOpen(true)} className="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-blue-50 px-4 py-2 rounded-lg font-bold text-blue-700 hover:bg-blue-100 border border-blue-200 text-xs shadow-sm transition-all"><Icons.Eye size={14} /> Yazdırma Önizleme</button>
                            <button onClick={() => window.print()} className="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-white px-4 py-2 rounded-lg font-bold text-slate-600 border border-slate-200 text-xs shadow-sm transition-all active:scale-95"><Icons.Printer size={14} /> Direkt Yazdır</button>
                            <button onClick={() => openEntryForm()} className="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-slate-900 text-white px-5 py-2 rounded-lg font-bold shadow-md text-xs transition-all active:scale-95"><Icons.UserPlus size={14} /> Yeni Hasta Ekle</button>
                            <button onClick={handleLogout} className="flex-none flex items-center justify-center gap-2 bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-100 border border-red-200 text-xs shadow-sm transition-all" title="Çıkış Yap"><Icons.LogOut size={14} /></button>
                        </div>
                    </header>
                    <section className="mb-4 space-y-3">
                        <div className="relative group">
                            <Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-slate-900 transition-colors" size={16} />
                            <input type="text" placeholder="Oda, hasta veya tanı ara..." className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-slate-900 outline-none text-sm shadow-sm transition-all" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                        </div>
                        <div className="flex gap-1.5 flex-wrap items-center bg-white/50 p-1.5 rounded-xl border border-slate-200/50 overflow-x-auto">
                            <button onClick={() => setFilterHoca('Hepsi')} className={`px-3 py-1.5 rounded-lg text-[10px] font-black border ${filterHoca === 'Hepsi' ? 'bg-slate-900 text-white border-slate-900 shadow-sm' : 'bg-white text-slate-500 border border-slate-200'}`}>HEPSİ</button>
                            {Object.keys(DOCTOR_CONFIG).map(h => (
                                <button key={h} onClick={() => setFilterHoca(h)} className={`px-3 py-1.5 rounded-lg text-[10px] font-black transition-all border ${filterHoca === h ? `${DOCTOR_CONFIG[h].accent} text-white border-transparent shadow-sm` : `bg-white ${DOCTOR_CONFIG[h].text} ${DOCTOR_CONFIG[h].border} hover:bg-white`}`}>{h}</button>
                            ))}
                        </div>
                    </section>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        {visibleRooms.map(roomNo => {
                            const p = patients[roomNo];
                            const config = p ? (DOCTOR_CONFIG[p.hoca] || DOCTOR_CONFIG['SAG']) : null;
                            return (
                                <div key={roomNo} className={`bg-white border rounded-xl shadow-sm flex flex-col transition-all overflow-hidden ${p ? 'border-slate-300 shadow-md ring-1 ring-slate-200' : 'border-dashed border-slate-300 opacity-60'}`}>
                                    <div className={`p-2 flex items-center justify-between border-b ${config ? config.bg : 'bg-slate-50'}`}>
                                        <div className="flex items-center gap-3">
                                            <span className={`w-10 h-10 flex items-center justify-center ${roomNo.includes('C') ? 'bg-indigo-600' : 'bg-slate-900'} text-white font-black text-xl rounded-lg shrink-0 shadow-sm border border-white/20`}>{roomNo}</span>
                                            <div className="min-w-0">
                                                <h3 className="text-sm font-black uppercase truncate leading-none text-slate-900">{p ? p.hastaAdi : 'BOŞ ODA'}</h3>
                                                {p && <p className="text-[10px] italic text-slate-500 truncate leading-none mt-1">{p.taniAmeliyat}</p>}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3 shrink-0">
                                            {p && <div className="text-center"><p className="text-[7px] font-bold text-slate-400 uppercase tracking-tighter">POSTOP</p><p className="font-bold text-xs leading-none">{p.postOp}</p></div>}
                                            {p && <div className="text-center bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100 shadow-sm"><p className="text-[7px] font-bold text-emerald-600 uppercase tracking-tighter">REJİM</p><p className="font-black text-[10px] leading-none text-emerald-800 uppercase italic">{p.rejim || '-'}</p></div>}
                                            {p && <span className={`px-1.5 py-0.5 rounded text-[8px] font-black border ${config.border} ${config.bg} ${config.text} uppercase`}>{p.hoca}</span>}
                                            <div className="flex gap-1">
                                                <button onClick={(e) => { e.stopPropagation(); openEntryForm(roomNo); }} className="p-1.5 hover:bg-white/50 rounded-lg text-slate-400 hover:text-slate-900 transition-transform active:scale-90"><Icons.Edit3 size={14} /></button>
                                                {p && <button onClick={(e) => { e.stopPropagation(); deletePatient(roomNo); }} className="p-1.5 hover:bg-white/50 rounded-lg text-slate-300 hover:text-red-500 transition-transform active:scale-90"><Icons.Trash2 size={14} /></button>}
                                            </div>
                                        </div>
                                    </div>
                                    {p ? (
                                        <div className="flex flex-col flex-1 text-[9px] bg-white">
                                            <div className="flex border-b">
                                                <div className="w-[15%] border-r p-1.5 space-y-1 bg-orange-50/5">
                                                    <div className="flex justify-between border-b border-orange-100 pb-0.5"><span>At:</span> <span className="font-bold text-orange-600">{p.vitaller.ates || '-'}</span></div>
                                                    <div className="flex justify-between border-b border-orange-100 pb-0.5"><span>Nb:</span> <span>{p.vitaller.nabiz || '-'}</span></div>
                                                    <div className="flex justify-between border-b border-orange-100 pb-0.5"><span>TA:</span> <span>{p.vitaller.ta || '-'}</span></div>
                                                    <div className="flex justify-between font-bold"><span>St:</span> <span>{p.vitaller.sat || '-'}</span></div>
                                                </div>
                                                <div className="w-[15%] border-r p-1.5 space-y-1 bg-emerald-50/5">
                                                    <div className="flex justify-between border-b border-emerald-100 pb-0.5 font-bold"><span>A:</span> <span>{p.act.aldigi || '-'}</span></div>
                                                    <div className="flex justify-between border-b border-emerald-100 pb-0.5 font-bold"><span>Ç:</span> <span>{p.act.cikardigi || '-'}</span></div>
                                                    <div className="flex justify-between border-b border-emerald-100 pb-0.5 font-medium"><span>Dr:</span> <span>{p.act.dren1 || '0'}</span></div>
                                                    <div className="flex justify-between font-bold"><span>Hw:</span> <span>{p.act.hemovac || '0'}</span></div>
                                                </div>
                                                <div className="flex-1 grid grid-rows-2">
                                                    <div className="p-1.5 border-b italic font-medium leading-tight break-words border-slate-100 overflow-y-auto max-h-[50px]"><span className="text-[7px] text-slate-400 uppercase font-black block">Tedavi:</span> {p.tedavi}</div>
                                                    <div className="p-1.5 font-black text-indigo-700 italic break-words leading-tight bg-indigo-50/5 overflow-y-auto max-h-[50px] relative"><span className="text-[7px] text-slate-400 uppercase font-black block">Kan Snç:</span> 
                                                        <div className="flex flex-wrap gap-1 mt-1">
                                                            {p.kanSonucGorseller?.map((img, idx) => (
                                                                <div key={idx} className="w-8 h-8 rounded border border-indigo-200 overflow-hidden cursor-zoom-in relative group/img shrink-0" onClick={() => setLightboxImage(img)}>
                                                                    <img src={img} alt="Tahlil" className="w-full h-full object-cover" />
                                                                    <div className="absolute inset-0 bg-indigo-600/20 opacity-0 group-hover/img:opacity-100 flex items-center justify-center transition-opacity"><Icons.Maximize2 size={8} className="text-white" /></div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                        {p.kanSonuc}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="p-2 border-b bg-yellow-50/20"><h4 className="text-[7px] font-black text-slate-400 uppercase tracking-widest mb-0.5">İş Listesi :</h4><p className="text-[10px] font-black text-slate-800 break-words whitespace-pre-wrap leading-snug">{p.isListesi || '-'}</p></div>
                                            <div className="p-2 flex-1 bg-slate-50/50 min-h-[40px]"><h4 className="text-[7px] font-black text-slate-400 uppercase tracking-widest mb-0.5">Anamnez :</h4><p className="text-[10px] font-medium text-slate-600 leading-relaxed italic break-words whitespace-pre-wrap">{p.anamnez || "Kayıt bulunamadı."}</p></div>
                                        </div>
                                    ) : (
                                        <div className="flex-1 flex items-center justify-center p-8 bg-slate-50/30"><button onClick={() => openEntryForm(roomNo)} className="flex items-center gap-2 text-slate-400 hover:text-slate-900 font-bold transition-all text-[10px] group uppercase tracking-widest bg-white border-2 border-dashed border-slate-200 px-4 py-2 rounded-xl"><Icons.PlusCircle size={16} /> {roomNo} Boş Yatak</button></div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[1000] bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4 overflow-y-auto">
                            <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] border border-slate-200">
                                <div className="p-4 border-b flex justify-between items-center bg-white rounded-t-2xl">
                                    <div className="flex items-center gap-2"><Icons.Edit3 className="text-slate-900" size={18} /><h2 className="text-sm font-bold tracking-tight text-slate-900 uppercase">{isNewPatientEntry ? "Yeni Kayıt" : `Oda ${formData.odaNo} - Veri Girişi`}</h2></div>
                                    <button onClick={() => setIsModalOpen(false)} className="p-1.5 hover:bg-slate-100 rounded-full transition-all active:scale-90"><Icons.X size={20} className="text-slate-400" /></button>
                                </div>
                                <div className="p-5 overflow-y-auto flex-1 grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50/20">
                                    <div className="space-y-4">
                                        <section className="space-y-3">
                                            <h4 className="text-[9px] font-bold text-slate-400 uppercase tracking-widest border-b pb-1">KİMLİK VE ODA</h4>
                                            <input type="text" className="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-slate-900 outline-none font-bold uppercase text-sm" placeholder="HASTA ADI SOYADI" value={formData.hastaAdi} onChange={(e) => setFormData({...formData, hastaAdi: e.target.value})} />
                                            <div className="grid grid-cols-2 gap-3">
                                                <select className="w-full px-3 py-2 rounded-lg border border-slate-200 font-bold text-xs bg-white" value={formData.hoca} onChange={(e) => setFormData({...formData, hoca: e.target.value})}>{Object.keys(DOCTOR_CONFIG).map(h => <option key={h} value={h}>{h}</option>)}</select>
                                                <input type="text" className={`w-full px-3 py-2 rounded-lg border font-bold text-xs ${!isNewPatientEntry ? 'bg-slate-100 text-slate-400' : 'bg-white focus:border-slate-900'}`} placeholder="ODA NO" value={formData.odaNo} onChange={(e) => setFormData({...formData, odaNo: e.target.value})} disabled={!isNewPatientEntry} />
                                            </div>
                                            <textarea className="w-full px-4 py-2 rounded-lg border border-slate-200 h-16 text-xs font-medium italic focus:border-slate-900" placeholder="Tanı ve Ameliyat Bilgisi..." value={formData.taniAmeliyat} onChange={(e) => setFormData({...formData, taniAmeliyat: e.target.value})} />
                                        </section>
                                        <section className="space-y-2">
                                            <h4 className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">ANAMNEZ :</h4>
                                            <textarea className="w-full px-4 py-3 rounded-lg border border-slate-200 h-32 text-xs font-medium bg-white resize-none leading-relaxed" value={formData.anamnez} onChange={(e) => setFormData({...formData, anamnez: e.target.value})} />
                                        </section>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            <section className="space-y-2">
                                                <h4 className="text-[9px] font-bold text-orange-500 uppercase tracking-widest border-b border-orange-100 pb-1">VİTALLER</h4>
                                                <div className="bg-orange-50/50 p-3 rounded-xl space-y-2 border border-orange-100 shadow-inner">
                                                    <div className="flex items-center justify-between text-[10px] font-bold"><span>ATEŞ</span><input className="w-12 p-1 rounded border text-center font-bold" value={formData.vitaller.ates} onChange={(e) => setFormData({...formData, vitaller: {...formData.vitaller, ates: e.target.value}})} /></div>
                                                    <div className="flex items-center justify-between text-[10px] font-bold"><span>NABIZ</span><input className="w-12 p-1 rounded border text-center font-bold" value={formData.vitaller.nabiz} onChange={(e) => setFormData({...formData, vitaller: {...formData.vitaller, nabiz: e.target.value}})} /></div>
                                                    <div className="flex items-center justify-between text-[10px] font-bold"><span>TA</span><input className="w-14 p-1 rounded border text-center font-bold text-[9px]" placeholder="120/80" value={formData.vitaller.ta} onChange={(e) => setFormData({...formData, vitaller: {...formData.vitaller, ta: e.target.value}})} /></div>
                                                    <div className="flex items-center justify-between text-[10px] font-bold"><span>SAT</span><input className="w-12 p-1 rounded border text-center font-bold text-[9px]" value={formData.vitaller.sat} onChange={(e) => setFormData({...formData, vitaller: {...formData.vitaller, sat: e.target.value}})} /></div>
                                                </div>
                                            </section>
                                            <section className="space-y-2">
                                                <h4 className="text-[9px] font-bold text-emerald-500 uppercase tracking-widest border-b border-emerald-100 pb-1">AÇT & REJİM</h4>
                                                <div className="bg-emerald-50/50 p-3 rounded-xl space-y-2 border border-emerald-100 shadow-inner">
                                                    <div className="grid grid-cols-2 gap-1.5">
                                                        <input placeholder="Aldığı" className="p-1 rounded border text-center font-bold text-xs bg-white" value={formData.act.aldigi} onChange={(e) => setFormData({...formData, act: {...formData.act, aldigi: e.target.value}})} />
                                                        <input placeholder="Çıkan" className="p-1 rounded border text-center font-bold text-xs bg-white" value={formData.act.cikardigi} onChange={(e) => setFormData({...formData, act: {...formData.act, cikardigi: e.target.value}})} />
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-1.5">
                                                        <input placeholder="Dren 1" className="p-1 rounded border text-center text-[9px] font-bold bg-white" value={formData.act.dren1} onChange={(e) => setFormData({...formData, act: {...formData.act, dren1: e.target.value}})} />
                                                        <input placeholder="Hw" className="p-1 rounded border text-center text-[9px] font-bold bg-white" value={formData.act.hemovac} onChange={(e) => setFormData({...formData, act: {...formData.act, hemovac: e.target.value}})} />
                                                        <input placeholder="Dren 2" className="p-1 rounded border text-center text-[9px] font-bold bg-white" value={formData.act.dren2} onChange={(e) => setFormData({...formData, act: {...formData.act, dren2: e.target.value}})} />
                                                        <input placeholder="Dren 3" className="p-1 rounded border text-center text-[9px] font-bold bg-white" value={formData.act.dren3} onChange={(e) => setFormData({...formData, act: {...formData.act, dren3: e.target.value}})} />
                                                    </div>
                                                    <input className="w-full p-2 mt-1 rounded border text-center font-bold text-[9px] bg-white placeholder-emerald-300" placeholder="REJİM (SIVI/KATI)" value={formData.rejim} onChange={(e) => setFormData({...formData, rejim: e.target.value})} />
                                                </div>
                                            </section>
                                        </div>
                                        <section className="space-y-2">
                                            <h4 className="text-[9px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-200 pb-1">TAKİP VE ÇOKLU GÖRSEL</h4>
                                            <div className="space-y-2">
                                                <div className="bg-white p-2 rounded-lg border border-slate-200">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <span className="text-[10px] font-bold text-slate-400 uppercase">Kan Sonuçları & Görseller</span>
                                                        <label className="flex items-center gap-1 bg-indigo-50 text-indigo-600 px-2 py-1 rounded-md text-[10px] font-bold cursor-pointer hover:bg-indigo-100 transition-colors">
                                                            <Icons.PlusCircle size={12} /> Dosya Seç
                                                            <input type="file" className="hidden" accept="image/*" multiple onChange={handleImageUpload} />
                                                        </label>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 mb-2">
                                                        {formData.kanSonucGorseller?.map((img, idx) => (
                                                            <div key={idx} className="relative w-12 h-12 rounded border overflow-hidden group/img-preview">
                                                                <img src={img} className="w-full h-full object-cover" />
                                                                <button onClick={() => removeImage(idx)} className="absolute inset-0 bg-red-600/60 opacity-0 group-hover/img-preview:opacity-100 flex items-center justify-center text-white transition-opacity"><Icons.Trash2 size={16} /></button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <textarea className="w-full px-3 py-1 rounded border text-[10px] font-bold h-10 focus:border-indigo-500 outline-none" placeholder="Tahlil veya klinik notlar..." value={formData.kanSonuc} onChange={(e) => setFormData({...formData, kanSonuc: e.target.value})} />
                                                </div>
                                                <textarea className="w-full px-3 py-1 rounded-lg border text-[10px] font-bold h-8" placeholder="Tedavi Protokolü..." value={formData.tedavi} onChange={(e) => setFormData({...formData, tedavi: e.target.value})} />
                                                <textarea className="w-full px-3 py-2 rounded-lg border border-slate-300 font-bold text-slate-900 bg-white text-[11px] h-16 shadow-inner" placeholder="Günün İş Listesi" value={formData.isListesi} onChange={(e) => setFormData({...formData, isListesi: e.target.value})} />
                                                <div className="flex gap-4">
                                                    <div className="flex-1"><label className="text-[8px] font-bold text-slate-400 block mb-0.5 text-center uppercase tracking-tighter">POSTOP</label><input type="number" className="w-full p-2 rounded-lg border font-bold text-center text-sm" value={formData.postOp} onChange={(e) => setFormData({...formData, postOp: e.target.value})} /></div>
                                                    <div className="flex-1"><label className="text-[8px] font-bold text-slate-400 block mb-0.5 text-center uppercase tracking-tighter">Durum</label><select className="w-full p-2 rounded-lg border font-bold text-xs" value={formData.status} onChange={(e) => setFormData({...formData, status: e.target.value})}><option>Stabil</option><option>Kritik</option><option>Yarın Op</option><option>Taburcu</option></select></div>
                                                </div>
                                            </div>
                                        </section>
                                    </div>
                                </div>
                                <div className="p-4 border-t flex justify-end gap-3 bg-slate-50 rounded-b-2xl">
                                    <button onClick={() => setIsModalOpen(false)} className="px-5 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600 transition-colors">İptal</button>
                                    <button onClick={savePatient} className="px-8 py-2 bg-slate-900 text-white rounded-lg font-bold shadow hover:bg-slate-800 transition-all text-xs uppercase tracking-wider flex items-center gap-2"><Icons.CheckCircle2 size={14}/> Kaydı Tamamla</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
